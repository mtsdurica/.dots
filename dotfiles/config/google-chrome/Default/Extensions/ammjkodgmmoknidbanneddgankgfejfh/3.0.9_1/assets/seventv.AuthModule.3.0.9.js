import{d as z}from"./seventv.useModule.3.0.9.js";import{u as W,a as X}from"./seventv.useRouter.3.0.9.js";import{e as L,C as J,aA as Z,w as G,a4 as Q,A as O,l as c,f as a,s as S,B as R,k as w,j as E,Z as D,u as h,q as C,F as T,x,aH as Y,L as ee,aC as te,y as ne,z as oe,_ as ce,ax as se,a as ae}from"./seventv.index.3.0.9.js";import{f as ie}from"./seventv.index.3.0.93.js";import{u as re}from"./seventv.main.3.0.9.js";import{r as A,u as t,t as j,l as ue}from"./seventv.useUserAgent.3.0.9.js";import{L as K}from"./seventv.StarIcon.3.0.9.js";import{U as B}from"./seventv.UiButton.3.0.9.js";import{U as le}from"./seventv.UiFloating.3.0.9.js";class pe extends Map{refresh(){super.clear();const d=document.cookie.split(";").map(i=>i.trim());for(const i of d){const[m,n]=i.split("=");super.set(m,decodeURIComponent(n))}}get(d){return this.refresh(),super.get(d)}}const M=new pe;function de(){return M.refresh(),M}const fe=p=>(ne("data-v-83ba91e5"),p=p(),oe(),p),me={key:0},ke={key:1,class:"seventv-connect-popup-buttons"},ve=fe(()=>E("h3",null,"7TV - Sign In",-1)),he={key:0},_e={key:1},ge={key:2,class:"seventv-connect-popup-buttons"},ye=L({__name:"AuthButton",props:{slug:{}},emits:["connect"],setup(p){const d=p,{t:i}=J(),m=re(),n=m.identity,{appUser:_,identityFetched:f}=Z(m),P=de(),g=document.createElement("seventv-container");g.id="seventv-kick-connect";const y=document.createElement("seventv-container");y.id="seventv-kick-connect-nav";const b=A(null),U=A(null),r=A("idle"),I=A(null);async function V(){if(!n)return;I.value=null,r.value="connecting";const o=window.open("about:blank","_blank","width=1,height=1");if(!o)throw new Error("Failed to open window");o.blur(),o.document.body.innerText="Please wait for up to 10 seconds...";const s=new URLSearchParams({platform:"KICK",id:n.username});await(async()=>{let e=await fetch(`https://7tv.io/v3/auth/manual?${s.toString()}`).catch(u=>{I.value=u});if(!e||!e.ok)return Promise.reject("failed to get verification code");const k=await e.text();if(!await N(k).catch(u=>{Promise.reject(u)}).then(()=>!0)||(await ee(te(1e4+500)).toBeTruthy(),s.set("verify","1"),e=await fetch(`https://7tv.io/v3/auth/manual?${s.toString()}`,{credentials:"include"}).catch(u=>{Promise.reject(u)}),!e||!e.ok))return;const l=e.headers.get("X-Access-Token");o&&(o.location.href="https://7tv.app/auth/callback?token="+l),N("").catch(u=>{ue.error("failed to clear bio",u)}),Promise.resolve()})().catch(e=>{I.value=e,o.close()}).then(()=>{r.value="done"})}const q=/\[7TV:[0-9a-fA-F]+\]/g;async function N(o){var u;if(!n)return;const s=`[7TV:${o}]`,e=P.get("XSRF-TOKEN");if(!e)return;const k=new Headers;k.set("x-xsrf-token",e??""),k.set("Content-Type","application/json");const v=((u=n.bio)==null?void 0:u.replace(q,"").trim())??"",l=o?n.bio?`${v} ${s}`:s:v;fetch("https://kick.com/update_profile",{headers:{"content-type":"application/json","x-xsrf-token":e},referrer:"https://kick.com/dashboard/settings/profile",referrerPolicy:"strict-origin-when-cross-origin",body:JSON.stringify({id:n.numID,email:n.email,bio:l}),method:"POST",mode:"cors",credentials:"include"}).then(H=>{H.ok&&(n.bio=l)})}function $(){window.open("https://7tv.app/emotes","_blank")}function F(){b.value=null,r.value==="done"&&$()}return G(()=>{var s;const o=document.querySelector(".main-navbar");if(o&&((s=o.lastElementChild)==null||s.insertAdjacentElement("beforebegin",y)),d.slug){const e=document.querySelector(".channel-info, .stream-info");e&&e.insertAdjacentElement("afterend",g)}}),ie(U,F),Q(()=>{g.remove(),y.remove()}),(o,s)=>{var v;const e=O("tooltip"),k=O("t");return c(),a(T,null,[r.value!=="done"&&t(n)&&o.slug===t(n).username&&t(f)&&(!t(_)||!((v=t(_).connections)!=null&&v.some(l=>l.platform==="KICK")))?(c(),S(D,{key:0,to:t(g)},[R((c(),a("div",{class:"seventv-kick-connect",onClick:s[0]||(s[0]=l=>b.value=t(g))},[w(K,{class:"seventv-kick-connect-bouncy"}),E("p",null,j(t(i)("site.kick.connect_button_channel",{CHANNEL:"kick.com/"+o.slug})),1)])),[[e,"Connect "+o.slug+" on kick with 7TV!"]])],8,["to"])):h("",!0),r.value!=="done"?(c(),S(D,{key:1,to:t(y)},[R((c(),a("div",{class:"seventv-kick-connect-nav",onClick:s[1]||(s[1]=l=>b.value=t(y))},[w(K)])),[[e,t(i)("site.kick.connect_button_site")],[e,"bottom","position"]])],8,["to"])):h("",!0),b.value?(c(),S(le,{key:2,anchor:b.value,middleware:[t(Y)({padding:8})]},{default:C(()=>[E("div",{ref_key:"popupRef",ref:U,class:"seventv-connect-popup"},[t(_)?(c(),a(T,{key:1},[ve,r.value==="connecting"?(c(),a("p",he,j(t(i)("site.kick.connect_popup_connecting")),1)):(c(),a("p",_e,"Use this button to get signed into 7tv.app with your Kick account")),r.value!=="connecting"?(c(),a("div",ge,[w(B,{onClick:V},{default:C(()=>[x("Sign In")]),_:1})])):h("",!0)],64)):(c(),a(T,{key:0},[R(E("h3",null,null,512),[[k,"site.kick.connect_button_site"]]),t(n)?(c(),a("p",me,j(t(i)("site.kick.connect_popup_"+r.value,{ACTOR:t(n).username})),1)):h("",!0),r.value!=="connecting"?(c(),a("div",ke,[r.value!=="done"?(c(),a(T,{key:0},[w(B,{onClick:V},{default:C(()=>[x("Continue")]),_:1}),w(B,{onClick:F},{default:C(()=>[x("Cancel")]),_:1})],64)):(c(),S(B,{key:1,onClick:$},{default:C(()=>[x("Explore")]),_:1}))])):h("",!0)],64))],512)]),_:1},8,["anchor","middleware"])):h("",!0)],64)}}});const be=ce(ye,[["__scopeId","data-v-83ba91e5"]]),we=L({__name:"AuthModule",setup(p){const{markAsReady:d}=z("auth",{name:"Auth",depends_on:[]}),i=W(),m=X(i),n=A(""),_=se(n,1e3);return ae(()=>m.currentRoute,f=>{!f||f.name!=="channel"||(n.value=typeof f.params.channel=="string"?f.params.channel??"":"")},{immediate:!0}),d(),(f,P)=>(c(),S(be,{slug:t(_)},null,8,["slug"]))}}),je=Object.freeze(Object.defineProperty({__proto__:null,default:we},Symbol.toStringTag,{value:"Module"}));export{je as _};
