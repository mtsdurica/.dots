import{u as R,g as X}from"./seventv.index.3.0.93.js";import{e as w,i as Z,a as N,w as I,a4 as j,l as f,f as g,s as C,j as J,k as M,Z as B,u as L,F as E,_ as $,W as U,m as T,n as ee,ai as H,Q as te,p as ne,q as se,Y as oe,al as re}from"./seventv.index.3.0.9.js";import{d as ae}from"./seventv.useModule.3.0.9.js";import{u as ce,a as ie}from"./seventv.useRouter.3.0.9.js";import{O as z}from"./seventv.ReactHooks.3.0.9.js";import{a9 as le,r as x,u as y,t as ue,a as W,L as me,l as de}from"./seventv.useUserAgent.3.0.9.js";import{u as q}from"./seventv.useChannelContext.3.0.9.js";import{u as fe}from"./seventv.main.3.0.9.js";import{u as K}from"./seventv.useChatEmotes.3.0.9.js";import{u as P}from"./seventv.useCosmetics.3.0.9.js";import{L as pe}from"./seventv.StarIcon.3.0.9.js";import{u as he,E as _e}from"./seventv.EmoteMenu.3.0.9.js";import{p as ge}from"./seventv.ChatMessage.3.0.9.js";import{I as ve,k as F}from"./seventv.UserTag.3.0.9.js";import{E as ye}from"./seventv.Emote.3.0.9.js";import{u as Y}from"./seventv.TextPaintDirective.3.0.9.js";import{_ as Ee}from"./seventv.ChatData.vue_vue_type_script_setup_true_lang.3.0.9.js";const G=Symbol();function be(h,u){return h.config.globalProperties.$pinia._s.get(u)}const Ce=w({__name:"ChatAutocomplete",setup(h,{expose:u}){const t=Z(G);if(!t)throw new Error("Could not retrieve channel info");const{identity:o}=fe(),d=q(),r=K(d),l=P((o==null?void 0:o.id)??""),s=le(t,"currentMessage"),n=x(null);function c(){n.value}function e(a){!n.value||typeof n.value.textContent!="string"||(n.value.textContent+=n.value.textContent.charAt(a.length-1)===" "?a:` ${a}`,t&&(t.currentMessage=n.value.textContent))}function i(a,m){const{anchorOffset:p,focusOffset:v}=m,_=Math.min(p,v),k=Math.max(p,v),S=a.textContent??"",A=S.substring(0,v).lastIndexOf(" ",v),b=S.substring(A+1,_);if(!b)return;const D=[...Object.values(r.active),...Object.values(l.emotes)].find(Q=>Q.name.toLowerCase().startsWith(b.toLowerCase()));if(!D)return;const V=document.createTextNode(`${D.name} `),O=document.createRange();O.setStart(a,_-b.length),O.setEnd(a,k),O.deleteContents(),O.insertNode(V),m.collapse(V,D.name.length+1)}return N(s,c),R(n,"keydown",a=>{const m=document.getSelection();if(!m)return;const p=m.focusNode;if(!(!p||p.nodeName!=="#text"))switch(a.key){case"Tab":a.preventDefault(),i(p,m);break}}),I(()=>{n.value=document.getElementById("message-input")??null}),u({insertAtEnd:e}),(a,m)=>null}}),ke=w({__name:"ChatEmoteMenu",emits:["pick-emote"],setup(h,{emit:u}){const t=he(),o=document.getElementById("chatroom-footer"),d=document.createElement("seventv-container");function r(l){l.target instanceof HTMLElement&&(o!=null&&o.contains(l.target)||d.contains(l.target)||(t.open=!1))}return I(()=>{var n;const l=document.getElementById("chatroom");if(!l)return;const s=l.querySelector(".chat-message-row");s&&((n=s.lastElementChild)==null||n.insertAdjacentElement("beforebegin",d))}),j(()=>{d.remove()}),(l,s)=>(f(),g(E,null,[(f(),C(B,{to:y(d)},[J("button",{ref:"emoteMenuButton",class:"seventv-emote-menu-button",onClick:s[0]||(s[0]=n=>y(t).open=!y(t).open)},[M(pe,{provider:"7TV",class:"icon"})],512)],8,["to"])),y(t).open&&y(o)?(f(),C(_e,{key:0,"anchor-el":y(o),width:"20.5rem",scale:"0.62rem",onEmoteClick:s[1]||(s[1]=n=>u("pick-emote",n)),onClose:r},null,8,["anchor-el"])):L("",!0)],64))}});const xe=$(ke,[["__scopeId","data-v-21b9153f"]]),Me=/^https?:\/\//i,we=new Set(["w!","h!","v!","z!"]);function Se(h){var c;const u=[],t=h.body.split(" "),o=e=>{var i;return((i=h.localEmoteMap)==null?void 0:i[e])??h.emoteMap[e]},d=h.showModifiers;let r=-1,l,s=null;const n=(e,i)=>({kind:"VOID",range:[e,i],content:void 0});for(const e of t){const i=r+(e.length+1),a=o(e),m=o(t[t.indexOf(e)+1]),p=o(t[t.indexOf(e)-1]);a?(((c=a.data)==null?void 0:c.flags)??0)&256&&l?(l.content.overlaid[a.name]=a,u.push(n(r+1,i-1))):u.push(l={kind:"EMOTE",range:[r+1,i-1],content:{emote:a,overlaid:{},...a.isTwitchCheer?{cheerAmount:a.isTwitchCheer.amount,cheerColor:a.isTwitchCheer.color}:{}}}):!d&&m&&we.has(e)||!d&&p&&e.startsWith("ffz")&&e.length>3?u.push(n(r,i-1)):(s=Te(e))&&u.push({kind:"LINK",range:[r+1,i-1],content:{displayText:e,url:s.toString()}}),r=i,!a&&e&&(l=void 0)}return u.sort((e,i)=>e.range[0]-i.range[0]),u}function Te(h){try{const u=new URL(`https://${h.replace(Me,"")}`),{isIcann:t,domain:o}=ge(u.hostname);if(o&&t)return u}catch{}return null}const Le={key:0},Ae={key:1},Ie={key:0,class:"seventv-badge-list"},Oe=w({__name:"ChatMessage",props:{bind:{}},emits:["open-card"],setup(h,{emit:u}){const t=h,o=q(),d=K(o),r=P(t.bind.authorID),l=document.createElement("seventv-container"),s=x([]),n=x([]);R(t.bind.usernameEl.parentElement,"click",()=>{u("open-card",t.bind)});function c(){t.bind.usernameEl.insertAdjacentElement("beforebegin",l),r.paints.size&&Y(t.bind.usernameEl,Array.from(r.paints.values())[0].id),s.value.length=0;for(const e of t.bind.texts){const i=e.textContent??"",a=Se({body:i,chatterMap:{},emoteMap:d.active,localEmoteMap:{...r.emotes}}),m=[];let p=0;for(const k of a){const S=k.range[0],A=k.range[1],b=i.substring(p,S);b&&m.push(b),m.push(k),p=A+1}const v=i.substring(p);v&&m.push(v),n.value=m;const _=document.createElement("seventv-container");_.classList.add("seventv-text-token"),e.after(_),e.style.display="none",s.value.push(_)}}return N(r,c),U(c),j(()=>{for(const e of s.value)e.remove();for(const e of t.bind.texts)e.style.display="initial";l.remove()}),(e,i)=>(f(),g(E,null,[(f(!0),g(E,null,T(s.value,(a,m)=>(f(),C(B,{key:m,to:a},[(f(!0),g(E,null,T(n.value,(p,v)=>(f(),g(E,{key:v},[typeof p=="string"?(f(),g("span",Le,ue(p),1)):y(ve)(p)?(f(),g("span",Ae,[M(ye,{class:"seventv-emote-token",emote:p.content.emote,format:"WEBP"},null,8,["emote"])])):L("",!0)],64))),128))],8,["to"]))),128)),(f(),C(B,{to:y(l)},[y(r).badges.size?(f(),g("span",Ie,[(f(!0),g(E,null,T(y(r).badges,([a,m])=>(f(),C(F,{key:a,badge:m,type:"app",alt:m.data.tooltip},null,8,["badge","alt"]))),128))])):L("",!0)],8,["to"]))],64))}});const Ne=$(Oe,[["__scopeId","data-v-bc7d044d"]]),Be={key:0,class:"seventv-badge-list"},$e=w({__name:"ChatUserCard",props:{el:{},bind:{}},setup(h){const u=h,t=P(u.bind.authorID),o=document.createElement("seventv-container");return o.id="seventv-badge-container",o.style.width="100%",I(()=>{const d=u.el.querySelector(".information"),r=u.el.querySelector(".badges-container"),l=u.el.querySelector("a.username");r?r.appendChild(o):d&&d.insertAdjacentElement("afterend",o),l&&t.paints.size&&(l.style.width="fit-content",Y(l,Array.from(t.paints.values())[0].id))}),j(()=>{o.remove()}),(d,r)=>(f(),C(B,{to:y(o)},[y(t).badges.size?(f(),g("span",Be,[(f(!0),g(E,null,T(y(t).badges,([l,s])=>(f(),C(F,{key:l,badge:s,type:"app",alt:s.data.tooltip},null,8,["badge","alt"]))),128))])):L("",!0)],8,["to"]))}});const De=$($e,[["__scopeId","data-v-3c97e7fe"]]),Re=w({__name:"ChatObserver",props:{listElement:{}},setup(h){const u=h,t=W(new Map),o=x([]);function d(s){if(!s.hasAttribute("data-chat-entry"))return;const n=s.getAttribute("data-chat-entry"),c=s.querySelector(".chat-message-identity");if(!c)return;const e=c.querySelector(".chat-entry-username");if(!e)return;const i=e.getAttribute("data-chat-entry-user-id"),a=e.getAttribute("data-chat-entry-user");if(!i||!a)return;const m=s.querySelectorAll(".chat-entry-content"),p={id:n,authorID:i,authorName:a,texts:Array.from(m),usernameEl:e,el:s};t.set(n,p)}async function r(s){const n=document.getElementById("chatroom");if(!n)return;let c=n.querySelector(".user-profile");c||(c=await new z((e,i)=>{for(const a of e)a.addedNodes.forEach(m=>{m instanceof HTMLDivElement&&m.classList.contains("user-profile")&&i(m)})},n,{childList:!0})),o.value.length=0,ee(()=>{c&&o.value.push({el:c,bind:s})})}function l(){const s=u.listElement.querySelectorAll("[data-chat-entry]");for(const n of Array.from(s))d(n)}return I(l),X(u.listElement,s=>{for(const n of s)n.addedNodes.forEach(c=>c instanceof HTMLDivElement?d(c):null),n.removedNodes.forEach(c=>c instanceof HTMLDivElement?t.delete(c.getAttribute("data-chat-entry")):null)},{childList:!0}),(s,n)=>(f(),g(E,null,[(f(!0),g(E,null,T(t,([c,e])=>(f(),C(Ne,{key:c,bind:e,onOpenCard:r},null,8,["bind"]))),128)),(f(!0),g(E,null,T(o.value,c=>(f(),C(De,{key:c.el,el:c.el,bind:c.bind},null,8,["el","bind"]))),128))],64))}});const je=$(Re,[["__scopeId","data-v-13e6cf6d"]]),qe=w({__name:"ChatController",props:{slug:{}},async setup(h,{expose:u}){let t,o;const d=h;u({onMessageSend:r});function r(){c("CHANNEL_ACTIVE_CHATTER",{channel:me(n)})}const l=([t,o]=H(()=>fetch(`https://kick.com/api/v2/channels/${d.slug}`).catch(v=>{de.error("failed to fetch channel data",v)})),t=await t,o(),t);if(!l)throw new Error("failed to fetch channel data");const{user_id:s}=([t,o]=H(()=>l.json()),t=await t,o(),t);if(!s)throw new Error("failed to get channel ID");const n=q(s.toString(),!0),{sendMessage:c}=te(),e=x(null),i=x(null),a=x(null);function m(v){a.value&&a.value.insertAtEnd(v)}let p=null;return I(async()=>{n.setCurrentChannel({id:s.toString(),username:d.slug,displayName:d.slug,active:!0})&&(e.value=null,i.value=null);const _=document.getElementById("chatroom-top");if(!(!_||!_.nextElementSibling))if(e.value=_.nextElementSibling,p&&p.disconnect(),_.nextElementSibling.firstElementChild)i.value=_.nextElementSibling.firstElementChild;else{p=new z((S,A)=>{for(const b of S)!b.target||!(b.target instanceof HTMLDivElement)||b.target.firstElementChild&&A(b.target.firstElementChild)},_.nextElementSibling,{childList:!0,subtree:!0});const k=await p;i.value=k}}),(v,_)=>(f(),g(E,null,[i.value?(f(),g(E,{key:0},[M(je,{"list-element":i.value},null,8,["list-element"]),M(Ce,{ref_key:"autocomplete",ref:a},null,512)],64)):L("",!0),M(Ee),M(xe,{onPickEmote:_[0]||(_[0]=k=>m(k.name))})],64))}}),Pe=w({__name:"ChatModule",setup(h){const{markAsReady:u}=ae("chat",{name:"Chat",depends_on:[]}),t=ce(),o=ie(t),d=x(null),r=W({active:!1,slug:"",currentMessage:""});ne(G,r);let l=!1;function s(){if(l)return;const n=be(t,"chatroomv2");n&&(l=!0,n.$subscribe(async(c,e)=>{!e.chatroom||typeof e.chatroom.id!="number"||(r.slug!==e.currentChannelSlug&&(r.active=!1,await new Promise(i=>setTimeout(i,250)),r.active=!0),r.slug=e.currentChannelSlug,r.currentMessage=e.currentMessage)}),N(()=>r.currentMessage,c=>{n==null||n.$patch({currentMessage:c})}),re(n,"sendCurrentMessage",function(...c){const e=c[0];return d.value&&d.value.onMessageSend(),e==null?void 0:e.apply(this,[])}))}return U(()=>{s()}),N(()=>o.currentRoute,s,{immediate:!0}),R(document,"click",s),u(),(n,c)=>r.active?(f(),C(oe,{key:0},{default:se(()=>[M(qe,{ref_key:"controller",ref:d,slug:r.slug},null,8,["slug"])]),_:1})):L("",!0)}}),ot=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"}));export{ot as _,be as u};
